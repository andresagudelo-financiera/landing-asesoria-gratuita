---
/**
 * TypebotWidget.astro
 * Integrates the Typebot chat widget (asesoria-gratuita-org-nova-050sprd).
 * Positioned on the LEFT via global CSS to balance with WhatsApp on the right.
 */
---

<script type="module">
    import Typebot from "https://cdn.jsdelivr.net/npm/@typebot.io/js@0.3/dist/web.js";
    window.Typebot = Typebot;

    // Helper to get UTM parameters and custom vars
    const getUTMParams = () => {
        const params = new URLSearchParams(window.location.search);
        const utmKeys = [
            "utm_source",
            "utm_medium",
            "utm_campaign",
            "utm_term",
            "utm_content",
            "type", // Requested custom param
            "coach", // Coach profile source
        ];
        const utmParams = {};

        utmKeys.forEach((key) => {
            if (params.has(key)) {
                utmParams[key] = params.get(key);
            }
        });

        // Add aliases for easier usage in Typebot
        if (utmParams.utm_source) utmParams.source = utmParams.utm_source;
        if (utmParams.utm_medium) utmParams.medium = utmParams.utm_medium;
        if (utmParams.utm_campaign) utmParams.campaign = utmParams.utm_campaign;

        return utmParams;
    };

    Typebot.initBubble({
        typebot: "asesoria-gratuita-org-nova-050sprd",
        apiHost: "https://typebot.co",
        previewMessage: {
            message: "ðŸš€ Iniciar mi Plan Financiero",
            autoShowDelay: 3000,
            //avatarUrl: "https://financieramentecompany.com/favicon.png",
        },
        prefilledVariables: getUTMParams(),
        theme: {
            button: {
                backgroundColor: "#2979ff" /* Claudia Blue */,
                iconColor: "#ffffff",
                size: "large",
            },
            previewMessage: {
                backgroundColor: "#ffffff",
                textColor: "#1a1a1a",
                closeButtonBackgroundColor: "#f5f5f5",
                closeButtonIconColor: "#333",
            },
            chatWindow: {
                backgroundColor: "#1a1a1a" /* Dark Theme */,
            },
        },
    });
</script>

<style is:global>
    /* 
    Force Typebot Bubble to the LEFT side.
    The custom element <typebot-bubble> is appended to body.
    We override standard positioning (usually right) with left.
  */
    typebot-bubble {
        position: fixed !important; /* Force fixed positioning */
        left: 1.5rem !important; /* left-6 approx */
        right: auto !important;
        bottom: 1.5rem !important; /* bottom-6 approx */
        z-index: 9999 !important; /* Ensure it's above everything */
        display: block !important;
        opacity: 1 !important;
    }
</style>
